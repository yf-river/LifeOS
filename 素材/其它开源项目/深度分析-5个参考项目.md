# 5个参考项目深度分析 - 实现模式与架构

本文档对 Prism 重构的 5 个参考项目进行深度分析，提取核心架构模式、技术栈、API设计和实现最佳实践。

---

## 目录
1. [FastGPT - AI Agent 平台](#fastgpt)
2. [memos - 碎片化笔记服务](#memos)
3. [blinko - 卡片笔记](#blinko)
4. [khoj - AI 第二大脑](#khoj)
5. [WeKnora - 文档检索框架](#weknora)
6. [关键启示总结](#关键启示总结)

---

## FastGPT

### 1. 项目定位
**AI Agent 构建平台** - 提供开箱即用的工作流编排和 RAG 能力

### 2. 技术栈
- **前端**: Next.js 14 + TypeScript + Chakra UI
- **后端**: Node.js (TypeScript)
- **数据库**: MongoDB (主存储) + PostgreSQL (向量存储)
- **向量DB**: Milvus 或 PG Vector
- **架构**: Monorepo (pnpm workspaces)

### 3. 核心项目结构

```
FastGPT/
├── packages/
│   ├── web/              # Next.js 前端应用
│   │   └── components/
│   ├── service/          # 核心业务逻辑
│   │   ├── core/         # 核心模块 (工作流、App、Chat、Dataset、Plugin)
│   │   │   ├── workflow/     # 工作流引擎 (dispatch/ 16个模块)
│   │   │   ├── app/          # App 管理
│   │   │   ├── chat/         # 聊天会话
│   │   │   ├── dataset/      # 知识库管理
│   │   │   └── plugin/       # 插件系统
│   │   ├── common/       # 共享工具库
│   │   │   ├── api/      # API 通用处理
│   │   │   ├── mongo/    # MongoDB 抽象
│   │   │   ├── redis/    # Redis 缓存
│   │   │   ├── vectorDB/ # 向量DB 适配
│   │   │   ├── cache/    # 缓存层
│   │   │   ├── bullmq/   # 任务队列
│   │   │   └── string/   # 字符串处理 (Tiktoken tokenizer)
│   │   ├── support/      # 支持模块
│   │   │   ├── user/     # 用户管理
│   │   │   ├── permission/ # 权限控制
│   │   │   ├── openapi/  # OpenAPI 适配
│   │   │   ├── mcp/      # MCP 协议支持 (新)
│   │   │   └── wallet/   # 账户/计费
│   │   ├── worker/       # 后台任务处理
│   │   │   ├── countGptMessagesTokens
│   │   │   ├── htmlStr2Md
│   │   │   ├── readFile
│   │   │   └── text2Chunks
│   │   ├── thirdProvider/ # 第三方集成
│   │   │   ├── doc2x/    # 文档解析
│   │   │   ├── textin/   # OCR服务
│   │   │   └── fastgptPlugin/
│   │   └── type/         # 类型定义
│   └── global/           # 全局类型和常量
├── projects/
│   └── mcp_server/       # MCP 服务器实现
└── deploy/               # 部署配置
```

### 4. 架构设计模式

#### 4.1 工作流引擎 (Workflow Engine)
FastGPT 的核心是可视化工作流编排系统:
- **dispatch/** 目录包含 16 个模块，处理不同类型的节点
- 支持节点类型: LLM、数据集检索、工具调用、条件判断、分支等
- **流式处理**: 支持流式输出和实时处理

**关键代码示例** (`workflow/utils.ts`):
```typescript
// 工作流工具集展开
export async function getSystemToolRunTimeNodeFromSystemToolset({
  toolSetNode,
  lang = 'en'
}) {
  // 动态获取系统工具集
  // 展开为独立节点，支持多语言
  // 返回可执行的运行时节点
}
```

#### 4.2 模块化架构
- **Core**: 业务逻辑核心 (App、Chat、Dataset、Workflow、Plugin)
- **Common**: 工具库 (数据库、缓存、向量搜索)
- **Support**: 横切关注点 (权限、API、用户)
- **Worker**: 后台任务处理

#### 4.3 多层存储设计
- **MongoDB**: 结构化数据 (应用配置、对话历史)
- **PostgreSQL + PG Vector**: 向量存储
- **Redis**: 实时缓存和会话
- **S3 兼容**: 文件存储

### 5. API 设计
FastGPT 暴露两套 API:
1. **gRPC Gateway**: 内部高性能通信
2. **OpenAPI**: 外部集成接口 (完整 API 文档)

### 6. 代码特点
- **TypeScript**: 完全 TS 编写，类型安全
- **Monorepo**: 多个 workspace，代码共享
- **国际化**: i18n 支持多语言 (i18next)
- **工作流序列化**: 节点配置可序列化为 JSON

### 7. 对 Prism 的启示

| 维度 | FastGPT 做法 | Prism 可借鉴 |
|------|-----------|-----------|
| **工作流** | 可视化节点编排，流式处理 | 思维模型执行可参考节点分解模式 |
| **多模态** | 文档解析集成 (doc2x, textin) | 视频/PDF 笔记集成 |
| **扩展性** | 工具集系统，OpenAPI | 模型库提供 API 给外部应用 |
| **实时性** | BullMQ 任务队列，Redis 缓存 | 笔记实时同步、搜索索引更新 |
| **向量检索** | PG Vector 或 Milvus | 笔记的语义搜索和自动链接 |

---

## memos

### 1. 项目定位
**隐私优先的碎片化笔记服务** - 类似 Twitter/微博 的流式记录

### 2. 技术栈
- **后端**: Go (Echo 框架)
- **前端**: React
- **通信**: gRPC + gRPC-Gateway
- **数据库**: SQLite (默认) / PostgreSQL (生产)
- **API**: RESTful + Protocol Buffers

### 3. 核心项目结构

```
memos/
├── server/
│   ├── router/
│   │   ├── api/v1/         # gRPC-Gateway 生成的 API
│   │   │   ├── memo_service.go      # 笔记 CRUD
│   │   │   ├── user_service.go      # 用户管理
│   │   │   ├── attachment_service.go # 附件处理
│   │   │   ├── memo_relation_service.go # 关系管理 (分享、收藏)
│   │   │   ├── reaction_service.go  # 反应/emoji
│   │   │   ├── auth_service.go      # 认证
│   │   │   ├── activity_service.go  # 活动日志
│   │   │   ├── health_service.go    # 健康检查
│   │   │   └── v1.go                # 网关入口
│   │   ├── fileserver/    # 文件服务 (Range request支持)
│   │   ├── rss/          # RSS 生成
│   │   └── frontend/     # 前端静态文件
│   ├── auth/             # 认证中间件
│   ├── runner/           # 后台任务
│   │   ├── memopayload/
│   │   └── s3presign/
│   └── server.go         # 服务器启动
├── internal/
│   └── profile/          # 配置管理
├── store/                # 数据存储层
├── proto/                # Protocol Buffers 定义
├── plugin/               # 插件系统
└── web/                  # React 前端
```

### 4. 架构设计模式

#### 4.1 gRPC-Gateway 模式
memos 使用 Protocol Buffers 定义 API，通过 gRPC-Gateway 自动生成 RESTful 接口:
```go
// server.go
apiV1Service := apiv1.NewAPIV1Service(s.Secret, profile, store)
apiV1Service.RegisterGateway(ctx, echoServer)  // 注册 gRPC-Gateway
```

**优势**:
- 单一数据模型 (proto) 定义
- 自动生成 REST API 和 gRPC 服务
- 类型安全，版本管理清晰

#### 4.2 模块化 Service 设计
每个资源 (Memo, User, Attachment) 对应一个 Service:
- `memo_service.go` - 笔记 CRUD
- `user_service.go` - 用户管理
- `reaction_service.go` - 互动反应
- `memo_relation_service.go` - 笔记关系 (分享、收藏、引用)

**Service 层职责**:
- 请求验证
- 业务逻辑处理
- 权限检查
- 数据模型转换

#### 4.3 插件系统
memos 支持插件扩展，允许第三方集成:
- `/plugin/` 目录
- 支持自定义命令和触发器

#### 4.4 关键特性

**时间轴设计**:
- 笔记流式展示 (类似 Twitter)
- 支持分页、搜索、过滤

**关系管理**:
- 笔记分享 (`memo_relation_service.go`)
- 收藏/标签
- 提及和引用

**权限模型**:
- 用户隔离 (多租户)
- 笔记可见性 (私密、朋友、公开)

### 5. API 设计

memos 的 API 设计采用 gRPC-Gateway，示例:
```
GET  /api/v1/memos
POST /api/v1/memos
GET  /api/v1/memos/:id
PATCH /api/v1/memos/:id
DELETE /api/v1/memos/:id
GET  /api/v1/memos/:id/reactions
POST /api/v1/memos/:id/reactions
```

**核心资源**:
- Memo (笔记)
- User (用户)
- Attachment (文件)
- MemoRelation (关系: 分享、收藏、引用)
- Reaction (互动: emoji、点赞)

### 6. 代码特点
- **轻量级**: 核心代码紧凑
- **极简 API**: 只暴露必要的接口
- **高效存储**: SQLite 优先 + PostgreSQL 支持
- **文件优化**: Range request 支持 (音视频流)

### 7. 对 Prism 的启示

| 维度 | memos 做法 | Prism 可借鉴 |
|------|----------|-----------|
| **API 设计** | gRPC-Gateway + Protocol Buffers | 事件流 API、复盘数据 API 可参考 |
| **模块化** | Service 按资源组织 | 模型/手册/目标 分别设计 Service |
| **时间轴** | 流式笔记展示 | 事件流展示、复盘时间轴 |
| **关系管理** | Relation Service | 笔记引用、思维模型关系图 |
| **轻量级** | SQLite 数据库 | Prism 本地优先，考虑 SQLite |
| **扩展性** | 插件系统 | 手册编辑插件、导入导出插件 |

---

## blinko

### 1. 项目定位
**AI 驱动的卡片笔记** - 快速捕捉灵感，AI 增强检索

### 2. 技术栈
- **桌面**: Tauri v2 (Rust + React)
- **后端**: Node.js + Typescript + Prisma ORM
- **前端**: React 18 + TypeScript
- **数据库**: SQLite (Prisma)
- **包管理**: bun (速度快)
- **AI 集成**: OpenAI + Ollama (本地)
- **MCP**: Model Context Protocol 支持

### 3. 核心项目结构

```
blinko/
├── app/                    # Tauri 桌面应用
│   ├── src/
│   │   └── (Tauri 配置)
│   └── Cargo.toml
├── server/                 # Node.js 后端
│   ├── aiServer/          # AI 服务模块
│   │   ├── mcp/           # MCP 协议实现 ★
│   │   │   ├── McpClientManager.ts    # MCP 客户端管理
│   │   │   ├── McpToolBridge.ts       # 工具桥接
│   │   │   └── index.ts
│   │   ├── providers/     # LLM 提供商 (OpenAI, Ollama等)
│   │   └── tools/         # AI 工具定义
│   ├── routerTrpc/        # tRPC API (类型安全的 RPC)
│   ├── routerExpress/     # Express 路由
│   │   ├── auth/          # 认证
│   │   └── file/          # 文件上传
│   ├── jobs/              # 后台任务
│   ├── lib/               # 工具库
│   ├── middleware/        # 中间件
│   └── types/             # 类型定义
├── shared/                # 前后端共享类型
├── prisma/
│   ├── schema.prisma      # 数据模型
│   └── migrations/
└── package.json
```

### 4. 架构设计模式

#### 4.1 MCP (Model Context Protocol) 集成 ★★★

blinko 的创新点之一是深度集成 MCP 协议，实现与任意外部工具的连接:

**McpClientManager.ts - 连接池管理**:
```typescript
export class McpClientManager {
  private connections: Map<number, McpConnection> = new Map();
  private connecting: Map<number, Promise<McpConnection>> = new Map();
  private cleanupTimer: ReturnType<typeof setInterval> | null = null;

  // 关键特性:
  // 1. 连接复用 (避免频繁连接/断开)
  // 2. 自动空闲断开 (5分钟超时)
  // 3. 并发连接管理 (Promise缓存)
  // 4. 自动清理定时器
}
```

**支持的传输协议**:
- STDIO (本地进程通信)
- SSE (Server-Sent Events)
- HTTP (StreamableHTTP)

**McpToolBridge.ts - 工具桥接**:
- 将 MCP 工具转换为 AI 可调用的工具
- 处理工具调用和结果返回

#### 4.2 分层 AI 架构

**providers/** 目录:
- 抽象 LLM 提供商接口
- 支持 OpenAI、Ollama、Anthropic 等

**tools/** 目录:
- 定义 AI 可用的工具
- 工具函数签名标准化

#### 4.3 类型安全的 API (tRPC)

blinko 使用 tRPC 替代传统 REST API:

**优势**:
- 前后端类型共享 (zero-cost abstraction)
- 自动类型检查
- IDE 自动补全
- 更少的 API 文档维护

**使用示例**:
```typescript
// 前端调用，TypeScript 自动推断返回类型
const result = trpc.note.create.mutate({ content: "..." });
```

#### 4.4 Tauri 桌面应用

blinko 使用 Tauri 而非 Electron:
- **更轻量**: ~50MB vs ~200MB (Electron)
- **安全**: Rust 内存安全
- **性能**: 更快启动和运行

### 5. AI 工作流

```
用户输入
  ↓
AI Server (aiServer/)
  ├─ Provider (选择 LLM)
  ├─ Tools (定义可用工具)
  └─ MCP (连接外部工具)
  ↓
执行 (调用工具、生成内容)
  ↓
存储 (Prisma ORM → SQLite)
```

### 6. 数据模型 (Prisma)

```prisma
model Note {
  id        String   @id @default(cuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  // ... 更多字段
}

model McpServer {
  id       Int     @id @default(autoincrement())
  name     String
  type     String  // STDIO, SSE, HTTP
  config   Json    // 连接配置
  // ...
}
```

### 7. 对 Prism 的启示

| 维度 | blinko 做法 | Prism 可借鉴 |
|------|-----------|-----------|
| **MCP 支持** | 深度集成，连接池管理 | Prism 可作为 MCP 服务器，接入外部工具 |
| **本地优先** | Tauri + SQLite + Ollama | Prism 采用 Tauri 构建桌面应用 |
| **类型安全** | tRPC 前后端类型共享 | 思维模型定义可参考类型共享模式 |
| **AI 工作流** | Provider + Tools + MCP | 思维模型执行可参考工具链设计 |
| **轻量级** | Bun 包管理，快速开发 | 开发环境可采用 Bun |

---

## khoj

### 1. 项目定位
**个人的 AI 第二大脑** - 本地/云端 RAG + 多端客户端

### 2. 技术栈
- **后端**: Python (FastAPI)
- **前端**: React (Web)
- **客户端**: Emacs 插件、Obsidian 插件、Android、Desktop
- **向量DB**: PostgreSQL + pgvector (默认)、Milvus、Pinecone
- **LLM**: 本地 (Ollama) 或云端

### 3. 核心项目结构

```
khoj/
├── src/
│   ├── khoj/
│   │   ├── routers/          # API 路由
│   │   ├── app.py            # FastAPI 应用入口
│   │   ├── search_type/      # 搜索类型 ★
│   │   │   └── text_search.py    # 文本搜索实现
│   │   ├── search_filter/    # 搜索过滤
│   │   ├── processor/        # 内容处理器
│   │   │   ├── content/      # 内容导入 (Markdown, Org, PDF等)
│   │   │   ├── conversation/ # 对话处理
│   │   │   ├── embeddings.py # 嵌入生成
│   │   │   ├── image/        # 图像处理
│   │   │   ├── speech/       # 语音处理
│   │   │   ├── operator.py   # 操作编排
│   │   │   └── tools.py      # 工具定义
│   │   ├── database/         # 数据库抽象
│   │   ├── utils/            # 工具库
│   │   └── telemetry/        # 遥测
│   ├── interface/            # 多端客户端
│   │   ├── web/              # Web 界面
│   │   ├── desktop/          # 桌面应用
│   │   ├── emacs/            # Emacs 模式
│   │   ├── obsidian/         # Obsidian 插件
│   │   └── android/          # Android 应用
├── tests/
└── pyproject.toml
```

### 4. 架构设计模式

#### 4.1 多端客户端设计

khoj 的强大之处在于多端支持，每个客户端独立实现:

| 客户端 | 类型 | 特点 |
|------|------|------|
| Web | React 应用 | 完整功能，可视界面 |
| Emacs | Elisp 插件 | 深度集成，快捷键驱动 |
| Obsidian | JS 插件 | 笔记库集成，知识图谱联动 |
| Desktop | PyQt/Electron | 离线优先 |
| Android | Native | 移动搜索 |

**架构启示**: 后端通过标准化 API (OpenAPI/GraphQL)，各端独立实现 UI

#### 4.2 搜索类型模块化

khoj 将搜索解耦为可插拔的搜索类型:

```python
# search_type/text_search.py
class TextSearch:
    def search(query, top_k=5):
        # 向量搜索 + 混合检索
        # 支持过滤和重排
```

**支持的搜索类型**:
- Text (向量搜索)
- Image (图像搜索)
- PDF (文档搜索)
- 代码搜索

#### 4.3 内容处理管道

**processor/content/** 支持多种格式导入:
- Markdown (.md)
- Org-mode (.org)
- PDF
- 网页
- JSON

**流程**:
```
导入文件 → 解析 → 分块 → 嵌入 → 存储
```

#### 4.4 对话与工具调用

**processor/conversation**:
- 维护对话历史
- 支持 Agent 模式 (Tool Use)
- 记忆管理

**processor/tools**:
- 定义可用工具
- 工具调用编排
- ReACT 模式支持

### 5. API 设计

khoj 提供 RESTful API:
```
GET  /api/search
POST /api/chat
GET  /api/config
POST /api/content  # 导入内容
```

### 6. 特色功能

**多源聚合**:
- 支持多个笔记库同时搜索
- 支持多个知识源混合检索

**本地优先**:
- 支持 Ollama (本地 LLM)
- 所有数据本地存储
- 可离线运行

### 7. 对 Prism 的启示

| 维度 | khoj 做法 | Prism 可借鉴 |
|------|----------|-----------|
| **多端支持** | 后端 + 多个客户端 | Prism 后端 API + 多端应用 |
| **模块化搜索** | 搜索类型可插拔 | 思维模型库可参考插件化设计 |
| **内容导入** | 支持多种格式 | 手册支持多种导入方式 |
| **Agent 工具** | Tool Use + ReACT | 思维模型执行可参考 Agent 模式 |
| **本地优先** | Ollama 支持 | Prism 集成 Ollama |

---

## WeKnora

### 1. 项目定位
**基于大模型的文档理解检索框架** - 复杂异构文档的 GraphRAG

### 2. 技术栈
- **后端**: Go (Gin 框架)
- **文档解析**: Python (独立服务)
- **前端**: React
- **数据库**: DuckDB (分析) + Elasticsearch (搜索)
- **向量DB**: DuckDB 内置向量能力
- **任务队列**: Asynq (Go 实现)
- **部署**: Docker + Helm

### 3. 核心项目结构

```
WeKnora/
├── cmd/                  # 命令行工具
├── internal/             # 核心业务逻辑
│   ├── handler/         # HTTP 处理器
│   ├── service/         # 业务服务
│   ├── repo/            # 数据访问层
│   ├── model/           # 数据模型
│   └── pkg/             # 内部包
├── docreader/           # 文档解析服务 (Python) ★
│   ├── parser/          # 多格式解析器 (PDF, Word, HTML等)
│   ├── models/          # 向量化模型
│   ├── splitter/        # 文本分块
│   └── utils/           # 工具库
├── dataset/             # 数据集管理
├── frontend/            # React 前端
├── migrations/          # 数据库迁移
├── config/              # 配置管理
├── docker/              # Docker 配置
├── helm/                # Kubernetes 部署
├── mcp-server/          # MCP 服务器
└── go.mod
```

### 4. 架构设计模式

#### 4.1 微服务分离

WeKnora 采用两层微服务架构:

**主服务 (Go/Gin)**:
- API 网关
- 业务逻辑
- 权限管理

**文档解析服务 (Python)**:
- 多格式文档解析
- 文本分块
- 向量化

**分离优势**:
- 技术栈独立 (Python 生态丰富)
- 可独立扩展
- 故障隔离

#### 4.2 文档解析管道

**docreader/** 实现完整的文档处理流程:

```python
文档 → 解析器 (PDF/Word/HTML)
     ↓
    抽取结构 (标题、表格、代码块)
     ↓
    文本分块 (智能分块)
     ↓
    向量化 (Embeddings)
     ↓
    存储 (DuckDB)
```

**支持格式**:
- PDF (含表单、图像)
- Word (.docx)
- HTML / 网页
- 纯文本
- Markdown
- 代码文件

#### 4.3 GraphRAG (知识图谱增强检索)

WeKnora 实现了 GraphRAG，在传统 RAG 基础上加入知识图谱:

**流程**:
```
文档 → 实体提取 → 关系构建 → 知识图谱
              ↓
          向量检索 + 图遍历
              ↓
          组合检索结果
```

**优势**:
- 不仅搜索语义相似的内容
- 还可发现隐含的关系和连接
- 提供更完整的上下文

#### 4.4 任务队列 (Asynq)

使用 Asynq 处理异步任务:
- 文档解析
- 向量化计算
- 索引更新

#### 4.5 DuckDB 多功能用途

WeKnora 采用 DuckDB 而非传统数据库:

**特点**:
- 内置分析 SQL
- 原生向量能力
- 高效的列式存储
- 支持 Parquet 导入导出

### 5. API 设计

```
POST /api/documents/import    # 导入文档
GET  /api/documents           # 列表文档
POST /api/search              # 搜索
POST /api/rag                 # RAG 查询
GET  /api/knowledge-graph     # 知识图谱
```

### 6. MCP 服务器支持

WeKnora 实现了 MCP 服务器 (`mcp-server/`)，可作为 AI Agent 的工具源:
- 文档搜索工具
- 知识图谱查询工具

### 7. 对 Prism 的启示

| 维度 | WeKnora 做法 | Prism 可借鉴 |
|------|------------|-----------|
| **文档处理** | 专用解析服务 (Python) | 笔记导入/转换可参考此模式 |
| **GraphRAG** | 知识图谱 + 向量检索 | 画像校准/深度分析可利用图结构 |
| **微服务** | Go 主服务 + Python 解析 | 模型执行与复盘分析可分离 |
| **任务队列** | Asynq 异步处理 | 复盘任务、索引更新可用队列管理 |
| **多向量DB** | DuckDB 原生向量 | 本地笔记可用 DuckDB |
| **MCP 支持** | 暴露工具接口 | Prism 思维模型可通过 MCP 暴露 |

---

## 关键启示总结

### 1. 架构层面

**A. 微服务分离**
- 文档处理 (异构格式) 应独立服务 (khoj, WeKnora 模式)
- Go 主服务 + Python 处理服务 (WeKnora 模式)
- 优势: 技术栈灵活、独立扩展、故障隔离

**B. 多端客户端**
- 后端统一 API，多端独立实现 (khoj 模式)
- Web + Desktop + 移动端分别开发
- Tauri 优于 Electron (blinko 经验)

**C. 本地优先**
- SQLite 本地存储 (memos, blinko)
- Ollama 本地 LLM (blinko, khoj)
- 数据主权和隐私保护

### 2. 数据设计

**A. 多层存储**
```
热数据 (Recent)      → Redis / SQLite
温数据 (Active)      → SQLite / PostgreSQL
冷数据 (Historical)  → 归档 / DuckDB

向量数据 → PG Vector / DuckDB / Milvus
```

**B. 向量检索进化**
- 简单阶段: 单纯向量相似度
- 进阶阶段: 混合检索 (向量 + 关键字)
- 高级阶段: GraphRAG (知识图谱 + 向量)

**C. 关系管理**
- 笔记关系 (分享、收藏、引用) - memos 模式
- 思维模型关系 (依赖、冲突) - 需要设计
- 自动链接 (基于语义) - reor 经验

### 3. API 设计

**A. 统一 API 规范**
- gRPC-Gateway + Protocol Buffers (memos)
- tRPC 类型安全 (blinko)
- RESTful + OpenAPI (FastGPT, khoj)

**推荐**: 采用 Protocol Buffers 定义，生成 OpenAPI 文档

**B. 插件化和扩展**
- MCP (Model Context Protocol) 成为标准 (blinko深度集成)
- 工具链设计 (Agent 工具) - FastGPT, khoj
- 第三方集成接口 - memos 插件系统

### 4. AI 工作流

**A. 工作流编排**
- 节点式编排 (FastGPT workflow)
- 参考: Prompt → Tool → Decision → Execute

**B. Agent 能力**
- 工具定义标准化
- Tool Use 模式 (khoj, blinko)
- ReACT 循环 (thinking → action → observation)

**C. 上下文管理**
- Token 限制 (FastGPT)
- 长期记忆 (对话历史、笔记库)
- 短期记忆 (当前会话)

### 5. 代码和工具链

**A. 技术栈选择**
| 层 | 推荐 | 备选 |
|----|-----|------|
| 后端 | Go (Gin) | Python (FastAPI) |
| 前端 | React | Vue3 |
| 桌面 | Tauri | Electron |
| 向量DB | PostgreSQL+pgvector | DuckDB / Milvus |
| 任务队列 | Asynq (Go) | Celery (Python) |
| ORM | Prisma / sqlc | GORM (Go) |

**B. 开发工具**
- Monorepo: pnpm workspaces (FastGPT) 或 Turbo (blinko)
- 包管理: bun 提升开发速度
- 类型定义: Protocol Buffers 或 TypeScript shared types

### 6. 对 Prism 的直接建议

**第一阶段 (基础架构)**:
1. 后端: Go + Gin (参考 memos, WeKnora)
2. 前端: React (参考 blinko, khoj)
3. 桌面: Tauri (参考 blinko)
4. 数据库: SQLite (本地) + PostgreSQL (服务端)
5. 向量DB: PG Vector (集成度高)

**第二阶段 (AI 能力)**:
1. 集成 Ollama (本地 LLM) - blinko 模式
2. 实现工具链 (CRUD 笔记、搜索、图谱查询) - FastGPT, khoj 模式
3. 支持 MCP (作为 MCP 服务器) - blinko 模式
4. 实现 GraphRAG - WeKnora 模式

**第三阶段 (多端支持)**:
1. Web 应用
2. 桌面应用 (Tauri)
3. CLI 工具
4. 浏览器扩展
5. 编辑器插件 (Obsidian, VSCode) - khoj 模式

**数据架构**:
```
事件流 (Events) → 处理 → 画像 (Profile) + 发现 (Findings)
     ↓
  三层索引
  ├─ L1: 决策索引 (决策模型、框架)
  ├─ L2: 摘要索引 (知识卡片)
  └─ L3: 全文索引 (原始数据)
  
  向量化 → PG Vector
  关系图 → 思维模型依赖关系
  GraphRAG → 自动链接发现
```

---

## 参考资源

### 项目链接
- FastGPT: https://github.com/labring/FastGPT
- memos: https://github.com/usememos/memos
- blinko: https://github.com/blinkochat/blinko
- khoj: https://github.com/khoj-ai/khoj
- WeKnora: https://github.com/Tencent/WeKnora

### 关键技术文档
- gRPC-Gateway: https://github.com/grpc-ecosystem/grpc-gateway
- tRPC: https://trpc.io/
- MCP (Model Context Protocol): https://spec.modelcontextprotocol.io/
- Protocol Buffers: https://developers.google.com/protocol-buffers

---

**文档生成时间**: 2026-01-03
**分析深度**: 代码级别 (源码阅读、架构分析、API 设计)
**适用场景**: Prism Next 重构参考、架构设计决策支持
